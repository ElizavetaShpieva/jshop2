
;;; ------------------------------------------------------------------------
;;; Declare all the data
;;; ------------------------------------------------------------------------

(defdomain test_bring
  (
    ;; basic block-stacking operators

    (:operator (!pickup ?a)
               ((on ?a ?loc))
               ((wrong_loc ?a) (on ?a ?loc))
               ((holding ?a) (has robot ?a)))

    (:operator (!putdown ?b)
               ()
               ((holding ?b))
               ((on-table ?b)))

    (:operator (!putdown ?b ?loc)
               ()
               ((on-tray ?b))
               ((on ?b ?loc)))

    (:operator (!put-on-tray ?b)
               ((on ?a ?loc))
               ((wrong_loc ?b) (on ?b ?loc))
               ((on-tray ?b) (has robot ?b)))               

    ; (:operator (!putdown ?b ?loc)
    ;            ()
    ;            ()
    ;            ((on ?b ?loc)))

    (:operator (!go_to ?loc)
               ((at robot ?to-loc))
               ((at robot ?to-loc))
               ((at robot ?loc)))

    (:operator (!unstack ?e ?f)
               ()
               ((clear ?e) (on ?e ?f))
               ((holding ?e) (clear ?f)))

    ;; book-keeping methods & ops, to keep track of what needs to be done
    (:operator (!!assert ?g)
               ()
               ()
               (?g)
               ;; Since !!ASSERT isn't a real blocks-world operator, make its cost 0
               0)

    (:operator (!!remove ?g)
               ()
               (?g)
               ()
               ;; Since !!REMOVE isn't a real blocks-world operator, make its cost 0
               )

    ;; The method for the top-layer task
    (:method (achieve-goals ?goals)
             ()
             ((assert-goals ?goals)
             (find-nomove) (add-new-goals) (find-movable) (move-block)))

    (:method (assert-goals (?goal . ?goals))
             ()
             ((!!assert (goal ?goal))
              (assert-goals ?goals)))

    (:method (assert-goals nil)
             ()
             ())

    (:method (find-nomove ?loc)
             ((object ?o) (location ?loc) (not (dont-move ?o)) (belongs ?o ?loc) (on ?o ?loc))
             ((!!assert (dont-move ?o)) (find-nomove ?loc))
             nil
             nil)



    (:method (find-movable ?loc)
             ((object ?o) (not (dont-move ?o)) (not (belongs ?o ?loc)) (on ?o ?loc)
              (not (wrong_loc ?o)))
             ; Decomposition
             ((!!assert (wrong_loc ?o)) (find-movable ?loc))


             nil
             nil)

    (:method (tidy_up ?loc)

             ((object ?o) (location ?loc) (location ?to-loc) (wrong_loc ?o) (belongs ?o ?to-loc) (not (on ?o ?to-loc)) (not (at robot ?to-loc)) (at robot ?loc) (not (has robot ?o)))
             ((bring ?o ?to-loc) (tidy_up ?loc))

             nil
             nil
             )

    (:method (bring ?o ?to-loc)

             ((object ?o) (location ?loc)  (location ?to-loc) (on ?o ?loc) (belongs ?o ?to-loc))
             ((bring ?o ?loc ?to-loc))
               
               nil
               nil
              )


    (:method (bring ?o ?loc ?to-loc)
             ((object ?o) (location ?loc) (location ?to-loc) (on ?o ?loc) (not (has robot ?o)))
             ((get ?o ?loc)(bring ?o ?loc ?to-loc))

             ((object ?o)  (location ?loc) (location ?to-loc) (not (on ?o ?loc)) (has robot ?o))
             ((carry ?o ?to-loc))

             nil
             nil
             )

    (:method (get ?o ?loc)
             ((location ?loc) (not (at robot ?loc)) (not (has robot ?o)))
             ((!go_to ?loc) (get ?o ?loc))

             ((object ?o) (location ?loc) (not (has robot ?o)))
             ((get ?o))

             nil
             nil)

    (:method (get ?o)
             ((object ?o) (location ?loc) (location ?to-loc) (has robot tray) (not (has robot ?o)) (not (on-tray ?o)))
             ((!put-on-tray ?o))

             ((object ?o) (not (has robot tray)) (not (has robot ?o)) (not (holding ?o)))
             ((!pickup ?o))

             nil
             nil)


    (:method (carry ?o ?loc)
             ;;((object ?o) (location ?loc) (not (on-tray ?o)))
             ;;((!put-on-tray ?o) (carry ?o ?loc))

             ((object ?o) (location ?loc) (not (at robot ?loc)))
             ((!putdown ?o ?loc))

             nil
             nil)


  )
)
